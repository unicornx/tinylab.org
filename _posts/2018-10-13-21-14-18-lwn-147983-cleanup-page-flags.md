---
layout: post
author: 'Wang Chen'
title: "LWN 147983: xxxx"
album: 'LWN 中文翻译'
group: translation
license: "cc-by-sa-4.0"
permalink: /lwn-147983/
description: "LWN 文章翻译，xxxx"
category:
  - 内存子系统
  - LWN
tags:
  - Linux
  - memory
---

> 原文：[Cleaning up some page flags](https://lwn.net/Articles/147983/)
> 原创：By corbet @ Aug 17, 2005
> 翻译：By [unicornx](https://github.com/unicornx) of [TinyLab.org][1]
> 校对：By [xxx](https://github.com/xxx)

> `struct page` is at the core of the memory management subsystem; one of these structures exists for every physical page of memory on the system (and for a few places which are not memory). Since a typical system will contain large numbers of `page` structures, there is a great deal of pressure to keep that structure small. But there are a lot of things that the kernel needs to know about pages. The result is that `struct page` contains a densely-packed `flags` field, and that the developers continually worry about running out of space for flags - even though a fair number of them are currently unused. Some of these flags also carry a fair amount of historical baggage which would be nice to clean up.

`struct page` 是内存管理子系统的核心; 这些结构中的一个存在于系统上的每个物理内存页面（以及一些不是内存的地方）。由于典型系统将包含大量页面结构，因此保持该结构较小存在很大压力。但是内核需要了解很多关于页面的内容。结果是 struct页面包含一个密集的标志字段，并且开发人员不断担心标志的空间不足 - 即使其中有相当数量的当前未使用。其中一些旗帜还带有相当数量的历史行李，这些行李很容易清理。

> Consider, for example, a flag called `PG_checked`. Its definition in `include/linux/page-flags.h` (2.6.13-rc6) reads as follows:

例如，考虑一个名为`PG_checked` 的标志。它在 `include/linux/page-flags.h` (2.6.13-rc6)中的定义如下：

    #define PG_checked		 8	/* kill me in 2.5.<early>. */

> Somebody clearly missed a deadline. In fact, there is a certain amount of confusion over just what this flag does. A bit of research revealed that it is used in several filesystems, and that it is unlikely to go away anytime soon. ext3 uses this flag to mark pages to be written to disk at a future time. AFS uses it to indicate valid directory pages. Reiserfs uses this flag for journaling purposes. And the (out-of-tree) cachefs implementation uses it to mark pages currently being written to local backing store.

有人显然错过了截止日期。事实上，对于这面旗帜的作用存在一定程度的混淆。一些研究表明它在几个文件系统中使用，并且不太可能很快消失。ext3使用此标志来标记将来要写入磁盘的页面。AFS使用它来指示有效的目录页面。Reiserfs使用此标志进行日记。并且（out-of-tree）cachefs实现使用它来标记当前正在写入本地后备存储的页面。

> So this flag clearly is not going away anytime soon, much less by 2.5.early. In an effort to clarify the situation, Daniel Phillips has posted [a patch](https://lwn.net/Articles/147988/) which renames the flag as follows:

所以这个标志显然不会很快消失，更不用说2.5了。为了澄清这种情况，丹尼尔菲利普斯发布了一个补丁，重新命名国旗如下：

    #define PG_fs_misc		 8	/* don't let me spread */

> There is some disagreement over naming, but the core of the patch is uncontroversial. This flag will officially be dedicated to filesystem use.

关于命名存在一些分歧，但补丁的核心是无可争议的。该标志将正式用于文件系统使用。

> Another flag with significant history is `PG_reserved`. In this case, too, the meaning of the flag has been somewhat obscured over time, though it can be summarized as "this page is special and the VM subsystem should leave it alone." It marks parts of the physical address space which have `page` structures, but which are not real memory - the legacy ISA hole in the i386 space, for example. The memory dedicated to the kernel text is also marked reserved. The kernel function which maps physical address spaces into a process's virtual space (`remap_pfn_range()`) will refuse to remap unreserved memory, leading to a long history of device drivers setting that flag to remap internal buffers.

具有重要历史的另一个标志是 `PG_reserved`。在这种情况下，标志的含义也随着时间的推移而有些模糊，但可以概括为“此页面是特殊的，VM子系统应该不管它”。它标记了具有页面结构的物理地址空间的一部分，但它们不是真正的内存 - 例如，i386空间中的传统ISA漏洞。专用于内核文本的内存也标记为保留。将物理地址空间映射到进程的虚拟空间（`remap_pfn_range()`）的内核函数将拒绝重新映射未预留的内存，从而导致设备驱动程序设置该标记以重新映射内部缓冲区的长历史。

> The consensus seems to be that the "reserved" flag can go. So Nick Piggin has been working on [a patch](http://lwn.net/Articles/146579/) which takes it out - mostly. In many cases, code which was testing that flag was really trying to decide if it was looking at a valid RAM page; there are other, better ways of making that test. In other cases, the higher-level VMA structure (which has its own `VM_RESERVED` flag) contains all of the needed information. In the `remap_pfn_range()` case, the test is simply removed, allowing all memory to be remapped. This change will modify the behavior of `/dev/mem`, which, previously, could not be used to `mmap()` regular RAM.

共识似乎是“保留”标志可以去。于是尼克Piggin一直致力于补丁 这需要它-居多。在许多情况下，测试该标志的代码确实试图决定它是否在查看有效的RAM页面; 还有其他更好的方法来进行测试。在其他情况下，更高级别的VMA结构（具有其自己的 `VM_RESERVED` 标志）包含所有所需信息。在 `remap_pfn_range()` 情况下，简单地删除了测试，允许重新映射所有内存。此更改将修改 `/dev/mem` 的行为，以前不能将其用于 `mmap()` 常规RAM。

> All that is left, after Nick's patch, is a set of tests in the software suspend code. Once that has been taken care of, `PG_reserved` can go.

在Nick的补丁之后剩下的就是软件暂停代码中的一组测试。一旦处理完毕，`PG_reserved` 就可以了。

[1]: http://tinylab.org
