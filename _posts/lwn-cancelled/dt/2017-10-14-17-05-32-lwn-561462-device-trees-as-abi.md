---
layout: post
author: 'Wang Chen'
title: "LWN 文章翻译 561462 - Device trees as ABI"
# tagline: " 子标题，如果存在的话 "
# album: " 所属文章系列/专辑，如果有的话"
# group: " 默认为 original，也可选 translation, news, resume or jobs, 详见 _data/groups.yml"
permalink: /lwn-561462/
description: "LWN 文章翻译 561462"
category:
  - category1
  - category2
tags:
  - tag1
  - tag2
---

> By Unicornx of [TinyLab.org][1]
> 2017-10-13 22:27:32

# 作为应用编程二进制接口的设备树

> By Jonathan Corbet  
> July 30, 2013  
> 
> [Last week's device tree article](https://lwn.net/Articles/560523/) introduced 
> the ongoing discussion on the status of device tree maintainership in the kernel 
> and how things needed to change. Since then, the discussion has only intensified 
> as more developers consider the issues, especially with regard to the stability 
> of the device tree interface. While it seems clear that most (but not all) participants 
> believe that device tree bindings should be treated like any other user-space ABI 
> exported by the kernel, it is also clear that they are not treated in this way 
> currently. Those seeking to change this situation will have a number of obstacles 
> to overcome.

[上周的设备树文章](https://lwn.net/Articles/560523/)介绍了有关内核中设备树维护的当前状态的讨论以及需要改进的地方。此后，随着更多的开发人员开始考虑这些问题，特别是在有关设备树接口的稳定性方面，讨论也变得愈加热烈。虽然看上去，大多数（但不是全部）参与者都认同对于设备树绑定应该像内核导出的任何其他用户空间ABI一样对待，但是很明显，他们当前没有这么去做。看来要改变当前的现状形势还是很严峻的。

> Device tree bindings are a specification of how the hardware is described to the 
> kernel in the device tree data structure. If they change in incompatible ways, 
> users may find that newer kernels may not boot on older systems (or vice versa). 
> The device tree itself may be buried deeply within a system's firmware, making 
> it hard to update, so incompatible binding changes may be more than slightly 
> inconvenient for users. The normal kernel rule is that systems that work with a 
> given kernel should work with all releases thereafter; no explicit exception 
> exists for device tree bindings. So, many feel, bindings should be treated like 
> a stable kernel ABI.

设备树绑定是一套以设备树的数据结构形式向内核描述硬件的规范。如果该规范以不兼容的方式更改，用户可能会发现较新的内核可能无法在旧系统上启动（反之亦然）。设备树描述本身可能被固化在系统的固件中，使其难以更新，因此相应规范的不兼容性对用户来说是一件糟糕的事情。通常的内核原则是当一个系统使用现有内核可以运行后，那么使用后继的新的内核版本中也应该可以运行; 设备树绑定也不例外。所以，大家都认可，定义绑定规则应该像一个稳定的内核 ABI 一样对待。

> Perhaps the strongest advocate of the position that device tree bindings should 
> be treated as any other ABI right now (rather than sometime in the future) is [ARM 
> maintainer Russell King](https://lwn.net/Articles/561464/):

最强烈主张从现在就开始（而不是将来的某个时候）就正式将设备树规则定义按照和其他 ABI
一样对待的人是 [ARM 子系统的维护者 Russell King](https://lwn.net/Articles/561464/)：
 
> > We can draw the line at an interface becoming stable in exactly the same way that 
> > we do every other "stable" interface like syscalls - if it's in a -final kernel, 
> > then it has been released at that point as a stable interface to the world. [...]
> >
> > If that is followed, then there is absolutely no reason why a "Stable DT" is not 
> > possible - one which it's possible to write a DT file today, and it should still 
> > work in 20 years time with updated kernels. That's what a stable interface _should_ allow, 
> > and this is what DT _should_ be.

> 和我们定义内核中其他“稳定的”接口的方法一样（譬如系统调用），我们需要严格控制接口进入主线的时间 - 只有当一个接口定义稳定了，我们才允许它进入最终的主线内核中。[...]
> 
> 如果我们严格遵循这个约定，那么绝对没有什么理由可以说提供一份“稳定的DT”是不可能的 - 我们今天写的一个 DT 文件，即使在20年后和最新的内核一起工作也不会有什么问题。这是一个稳定的接口"必须"满足的，也是 DT “必须” 做到的。

> As is often the case, though, there is a disconnect between what should be and what 
> really is. The current state of device tree stability was perhaps best [summarized](https://lwn.net/Articles/561465/) 
> by Olof Johansson:

然而，理想和现实是有差距的。Olof Johansson 给出了目前有关设备树的稳定性状态的最好总结：

> > Until now, we have been working under the assumption that the bindings are 
> > _NOT LOCKED_. I.e. they can change as needed, and we _ARE_ assuming that the 
> > device tree has to match the kernel. That has been a good choice as people get 
> > up to speed on what is a good binding and not, and has given us much-needed room 
> > to adjust things as needed.

到目前为止，我们一直工作于某种假设下，即绑定规则仍然是“未完全确定”的。即，我们可以根据需要随时更改它，并且随着内核的发展，相关的设备树规则也跟着改变。在当时人们还处于那种不是很确定究竟什么是好的选择状态下这种做法不啻是一个很好的选择，而且让我们有充分的缓冲来调整我们需要的东西。

> Other developers agreed with this view of the situation: for the first few years 
> of the ARM migration from board files to device trees, few developers (if any) 
> had a firm grasp of the applicable best practices. It was a learning experience 
> for everybody involved, with the inevitable result that a lot of mistakes were 
> made. Being able to correct those mistakes in subsequent kernel releases has 
> allowed the quick application of lessons learned and the creation of better 
> bindings in current kernels. But Olof went on to say that the learning period is 
> coming to a close: "That obviously has to change, but doing so needs to be done 
> carefully." This transition will need to be done carefully indeed, as can be seen 
> from the issues raised in the discussion.

其他开发人员都对这种情况表示同意：对于 ARM 子系统，从板级配置文件迁移到设备树的最初几年中，能够熟练掌握设备树应用技能的开发人员很少。对于参与的每个人来说，这是一个学习过程，所以最初不可避免地犯了很多错误。在随后的内核版本的快速迭代，使得我们可以将经验教训快速应用起来改进到新的内核中。但是，Olof 接着说，这种学习期即将结束：“ 这显然是必须改变的，但这样做需要非常小心。” 从我们对该问题的讨论中可以也看出这一转变需要仔细规划。

> ## Toward stable bindings
> ## 朝着稳定版本的绑定前进

> For example: what should be done about "broken" bindings that exist in the kernel 
> currently? Would they immediately come under a guarantee of stability, or can they 
> be fixed one last time? There is a fair amount of pressure to stop making incompatible 
> changes to bindings immediately, but to do so would leave kernel developers supporting 
> bindings that do not adequately describe the hardware, are not extensible to newer 
> versions of the hardware, and are inconsistent with other bindings. Thus, Tomasz 
> Figa [argued](https://lwn.net/Articles/561469/), current device tree bindings should be viewed as a replacement for 
> board files, which were very much tied to a specific kernel version:

目前存在的问题包括：对于当前内核中已经存在的“有问题”的绑定设计如何处置？是立即能够稳定下来，或者说能够一次性解决？我们面临相当大的压力需要立刻采取行动阻止继续引入不兼容的绑定设计，但是这样做会使那些负责定义绑定规则的内核开发人员无法获得充分的时间完整地描述硬件信息，对于较新版本的硬件的支持也会受到影响，以及与其他绑定的不一致性问题。因此，Tomasz Figa 认为，当前的设备树绑定应被重视起来，它将最终替代那些和特定内核耦合紧密的板级文件配置方案：

> > We have what we have, it is not perfect, some things have been screwed up, but 
> > we can't just leave that behind and say "now we'll be doing everything correctly", 
> > we must fix that up.

> 我们已经有了我们需要的解决方案，它并不完美，在有些问题上已经被搞砸了，但是我们不能视而不见，还说“我们计划如何去做好这件事”，我们必须立即动手解决这个问题。
 
> Others contend that, by releasing those bindings in a stable kernel, the community 
> already committed itself to supporting them. Jon Smirl has [advocated](https://lwn.net/Articles/561471/) for a solution 
> that might satisfy both groups: add a low-level "quirks" layer that would reformat 
> old device trees to contemporary standards before passing them to the kernel. That 
> would allow the definitive bindings to change while avoiding breaking older device 
> trees.

另一些则认为，通过在稳定的内核中发布绑定，社区已经承诺支持它们。Jon Smirl [主张](https://lwn.net/Articles/561471/)采用可以满足争论双方的解决方案：在系统的底层，内核之外再添加一个“特殊”层，该层负责将旧的设备树转化为最新的主线内核要求标准，然后再传递给内核。这将允许主线内核继续发展，同时旧的设备树依然可以和新内核共存。

> Another open question is: what is the process by which a particular set of bindings 
> achieves stable status, and when does that happen? Going back to Olof's original 
> message:

另一个有待解决的问题是：我们应该定义一个什么样的流程保证一个特定的绑定规则能够稳定下来，我们何时可以判断可以稳定了？回到 Olof 的那封邮件：

> > It's likely that we still want to have a period in which a binding is tentative 
> > and can be changed. Sometimes we don't know what we really want until after we've 
> > used it a while, and sometimes we, like everybody else, make mistakes on what is 
> > a good idea and not. The alternative is to grind most new binding proposals to a 
> > halt while we spend mind-numbing hours and hours on polishing every single aspect 
> > of the binding to a perfect shine, since we can't go back and fix it.

> 很可能我们仍然希望在一个绑定规则正式稳定下来之前能够保留一个时间段可以随时改变。因为很多情况下不试用一下我们还真的不知道是不是真的有问题，另外人为的设计错误也是在所难免。考虑到一旦正式发布就无法回滚，一种可能的选择就是在稳定下来之前我们们要花费大量的时间仔细的反复考虑。

> Following this kind of policy almost certainly implies releasing drivers in stable 
> kernels with unstable device tree bindings. That runs afoul of the "once it's shipped, 
> it's an ABI" point of view, so it will not be popular with all developers. Still, 
> a number of developers seem to think that, with the current state of the art, it 
> still is not possible to create bindings that are long-term supportable from the 
> beginning. Whether bindings truly differ from system calls and other kernel ABIs 
> in this manner is a topic of ongoing debate.

遵循这种政策几乎肯定意味着要在稳定版本的内核中带有非稳定版本的设备树以及与之绑定的驱动程序。这违反了“一旦发货，这是稳定的 ABI”的观点，所以它不会受到所有开发人员的欢迎。一些开发人员甚至认为，在当前形式下，不可能从一开始就创建长期可支持的绑定规则的。绑定规则的制定过程是否能够做到和制定系统调用这些其他的内核ABI一样，这将仍然是一个持续争论的话题。

> Regardless of when a binding is recognized as stable, there is also the question 
> of who does this recognition. Currently, bindings are added to the kernel by driver 
> developers and subsystem maintainers; thus, in some eyes, we have a situation where 
> the community is being committed to support an ABI by people who do not fully 
> understand what they are doing. For this reason, Russell [argued](https://lwn.net/Articles/561474/) that no device 
> tree binding should be merged until it has had an in-depth review by somebody 
> who not only understands device tree bindings, but who also understands the hardware 
> in question. That bar is high enough to make the merging of new bindings difficult 
> indeed.

暂且先不考虑什么时候绑定规则应该被认为是稳定的问题，究竟是谁来做出这个判断也是一个问题。目前，驱动程序开发人员和子系统维护者负责将绑定添加到内核中; 有些人也提出这些负责人是否真正具备资质做出正确的判断。因此，Russell [认为](https://lwn.net/Articles/561474/)，没有经过既懂设备数绑定规则又懂硬件的专家的深入审核，这些规则不应该被合入内核。自然这么做，会牵扯太多的人，使得合入一个绑定规则更加困难。

> Olof's message, instead, proposed the creation of a "standards committee" that 
> would review bindings for stable status. These bindings might already be in the 
> kernel but not yet blessed as "locked" bindings. As Mark Rutland (one of the new 
> bindings maintainers) [pointed out](https://lwn.net/Articles/561475/), this committee would need members from beyond 
> the Linux community; device tree bindings are supposed to be independent of any 
> specific operating system, and users may well want to install a different system 
> without having to replace the device tree. Stephen Warren (another new bindings 
> maintainer) [added](https://lwn.net/Articles/561476/) that bootloaders, too, make use of device trees, both to understand 
> the hardware and to tweak the tree before passing it to the kernel. So there are 
> a lot of constituents who would have to be satisfied by a given set of bindings.

相反，Olof 的邮件建议设立一个“标准委员会”来审查这些绑定规则是否达到稳定状态。这些绑定可能已经在主线内核中，但还没有被承认为“稳定”版本。正如 Mark Rutland（新的设备树绑定规则维护者之一）[指出的那样](https://lwn.net/Articles/561475/)，该委员会的成员需要一些 Linux 社区以外成员加入; 设备树绑定规则应该是独立于任何特定的操作系统的，用户可能希望安装不同的系统，而无需更换设备树。Stephen Warren （另一个新的绑定规则维护者）[补充说](https://lwn.net/Articles/561476/) 引导加载程序也会使用设备树来了解硬件，并可能会在将其传递给内核之前对其进行调整。所以对于一个给定的绑定规则时需要参与审核的组员会来自方方面面。

> Tied to this whole discussion is the idea of moving device tree bindings out of 
> the kernel entirely and into a repository of their own. Such a move would have 
> the effect of decoupling bindings from specific kernel releases; it would also 
> provide a natural checkpoint where bindings could be carefully reviewed prior to 
> merging. Such a move does not appear to be planned for the immediate future, but 
> it seems likely to happen eventually.

和整个讨论非常相关的一个思路是将设备树绑定规则从内核完全移出到自己的代码维护仓库中。这样的举动将有助于解除设备数规则和特定内核版本的依赖; 它还将提供一个自然的检查点，在合并之前可以仔细检查绑定。这样的举措似乎并不可能在近期计划内，但最终似乎是会这样的。

> There are also some participants who questioned the value of stable bindings in 
> the first place. In particular, Jason Gunthorpe [described](https://lwn.net/Articles/561477/) the challenges faced 
> by companies shipping embedded hardware with Linux:

还有一些参与者质疑在第一时间敲定绑定规则是否有必要。特别是 Jason Gunthorpe 的[介绍](https://lwn.net/Articles/561477/)，他的邮件描述了那些在其产品上使用 Linux 的嵌入式硬件公司所面临的挑战：

> > There is no way I can possibly ship a product with a DT that is finished. I can't 
> > tie my company's product release cycles to the whims of the kernel community.
> > 
> > So embedded people are going to ship with unfinished DT and upgrade later. They 
> > have to. There is no choice. Stable DT doesn't change anything unless you can 
> > create perfect stable bindings for a new SOC instantaneously.

> 我们无法等待最终版本的设备树完备再发布产品。公司产品的发布周期很难与内核社区的开发周期相匹配。

> 所以嵌入式工程师们将不得不使用非最终版本的设备树出货，然后在后期进行升级。他们必须这么做。没有别的选择。等待稳定的最终版本的设备树对制造产品的公司并没有什么特别的好处，除非使用稳定的版本可以无需修改立即支持新的 SOC 系统。

> In Jason's world, there is no alternative to being able to deal with device trees 
> and kernels that are strongly tied together, and, as he sees it, no effort to 
> stabilize device tree bindings is going to help. That led him to [ask](https://lwn.net/Articles/561478/): "So who 
> is getting the benefit of this work, and is it worth the cost?" That particular 
> question went unanswered in the discussion.

在杰森的工作中，别无选择，需要大量解决设备树和内核之间的依赖问题，而且正如他所看到的，稳定设备树绑定规则的工作对他并没有太大的帮助。这就导致他 问：“ 到底是谁会从这项工作中得到好处，这些工作有所谓的价值吗？ ” 这个特别的问题在讨论中没有得到相应的答复。

> Finally, in a world where device tree bindings have been stabilized, there is 
> still the question of how to ensure that drivers adhere to those bindings and 
> add no novelties of their own. The plan here appears to be the creation of a 
> schema to provide a formal description for bindings, then to augment the dtc 
> device tree compiler to verify device trees against the schema. Any strange 
> driver-specific bindings would fail to compile, drawing attention to the problem.

最后，在设备树绑定规则已经稳定的情况下，仍然存在如何确保驱动程序严格遵守这些绑定而不引入错误的理解的问题。这里的计划似乎是创建一个机制以提供绑定规则的形式描述，然后扩展 dtc，即设备树编译器来依据该形式描述验证设备树。这样可以确保任何错误的的绑定无法通过编译，从而提前引起开发人员对问题的注意。

> The conversation quickly acquired a number of interesting side discussions on 
> how the schema itself should be designed. A [suggestion](https://lwn.net/Articles/561480/) that XML could be used 
> evoked far less violence than one might imagine; kernel developers are still 
> trying hard to be nice, it seems. But David Gibson's [suggestion](https://lwn.net/Articles/561482/) that a more 
> C-like language be used seems more likely to prevail. The process of coming up 
> with comprehensive schema definition and checking that it works with all device 
> tree bindings is likely to take a while.

这番对话很快就获得了一些关于如何设计该形式描述本身的有趣的侧面讨论。一个[建议](https://lwn.net/Articles/561480/)是可以使用 XML ，看上去支持的人不在少数; 内核开发人员一直在努力追求卓越。David Gibson 则[建议](https://lwn.net/Articles/561482/)使用一种更类似 C 语言语法的的语言似乎更占上风。总的来说一种全面的模式定义从提出到其可以与所有设备树绑定一起工作，该过程可能还需要一段时间。

> Reaching a consensus on when device tree bindings should be stabilized, what to 
> do about substandard existing bindings, and how to manage the whole process will 
> also probably take a while. The topic has already been [penciled in](https://lwn.net/Articles/561483/) for an entire 
> afternoon during the ARM Kernel Summit, to be held in Edinburgh this October. In 
> the meantime, expect a lot of discussion without necessarily binding the community 
> to more stable device trees.

在确定何时设备树绑定规则应该稳定，如何标准化现存规则，以及如何管理整个流程这些事情上要达成共识可能还要假以时日。该主题已经被[列入](https://lwn.net/Articles/561483/)将在今年10月于爱丁堡举行的 ARM 内核峰会上继续讨论，估计要占用一整个下午的时间。与此同时，期待更多的讨论，而不必将社区绑定到更稳定的设备树中。（译者注，最后一句话不是很明白）